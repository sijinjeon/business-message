# 기능 상세 스펙 문서 - 06. 데이터베이스 및 스토리지

> **문서 버전**: 2.5 (2026.01.05 Update)
> **작성일**: 2026-01-01
> **업데이트**: 2026-01-05 - Gemini 3.0 마이그레이션 로직 및 최신 스키마 반영
> **담당 모듈**: `src/services/storage-service.ts`, `src/utils/storage.ts`

---

## 1. 개요 (v2.5)

본 프로젝트는 별도의 외부 DB 없이 `chrome.storage.local`을 메인 데이터 저장소로 사용합니다. 데이터의 무결성을 위해 `StorageService` 정적 클래스를 통해 모든 접근을 제어하며, 민감 정보는 암호화하여 저장합니다.

---

## 2. 데이터 스키마 (Full Specification)

### 2.1 AppStorage 인터페이스
```typescript
export interface AppStorage {
  // 1. 보안 인증 정보 (AES-GCM 암호화)
  apiKeys: {
    gemini: string;
    chatgpt: string;
    claude: string;
  };
  
  // 2. 일일 간략 통계
  dailyUsage: {
    date: string;  // YYYY-MM-DD
    count: number;
  };
  
  // 3. 상세 실행 로그 (최근 1,000개)
  usageLogs?: UsageLog[];
  
  // 4. 앱 설정
  settings: {
    selectedProvider: AIProvider;
    providerModels: {
      gemini: string;
      chatgpt: string;
      claude: string;
    };
    temperature: number;      // 기본값 0.7
    maxOutputTokens: number;  // 기본값 1024
    autoCopyEnabled: boolean;
    autoCopyTone: ToneType;
    instantToneStyle: ToneType;
    translation: TranslationSettings;
  };
  
  // 5. UI 상태 관리
  lastUsedTab: 'tone' | 'translation';
}
```

### 2.2 하위 인터페이스
- **UsageLog**: `timestamp`, `provider`, `model`, `task`, `inputTokens`, `outputTokens`, `cost`
- **TranslationSettings**: `defaultTargetLanguage`, `preserveLineBreaks`, `showNotification`

---

## 3. 데이터 보호 및 마이그레이션

### 3.1 암호화 전략
- **알고리즘**: AES-GCM 256-bit
- **키 생성**: PBKDF2 (100,000 iterations, Extension ID 기반 salt)
- **적용 필드**: `apiKeys` 하위 모든 필드

### 3.2 자동 마이그레이션 (2026 기준)
- 앱 초기화 및 데이터 로드 시 `StorageService.getAll()`에서 구형 모델 ID를 자동으로 최신 ID로 변환합니다.
    - `gemini-1.5-flash` → `gemini-2.5-flash` (기본값)
    - `gpt-4o-mini` → `gpt-5.2`
    - `claude-4-5-sonnet` 등 오타 교정 포함
    - `claude-3-5-sonnet-latest` → `claude-3-5-sonnet-20241022` (404 방지)

---

## 4. 핵심 메서드 가이드

### 4.1 StorageService (고수준 추상화)
- `getAll()`: 기본값 병합 및 마이그레이션이 적용된 전체 데이터 반환.
- `updateSettings(Partial<Settings>)`: 설정 데이터의 부분 업데이트.
- `saveApiKey(provider, encryptedKey)`: 암호화된 API 키 저장.

### 4.2 Storage Utils (실제 구현부)
- `logUsage(payload)`: 작업 완료 후 토큰 및 비용 정보를 계산하여 로그에 기록.
- `getApiKey(provider)`: 저장된 키를 복호화하여 평문으로 반환.

---

## 5. 성능 및 용량 제한

- **최대 로그 수**: `usageLogs`는 성능 유지를 위해 최근 1,000개로 제한(`slice(0, 1000)`).
- **데이터 병합**: 얕은 병합 대신 `deepMerge`를 사용하여 하위 설정값(`translation`, `providerModels`)이 손실되지 않도록 관리.

---

**문서 업데이트**: 2026-01-01
