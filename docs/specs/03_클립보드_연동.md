# 기능 상세 스펙 문서 - 03. 클립보드 연동

> **문서 버전**: 1.0  
> **작성일**: 2025-12-25  
> **담당 모듈**: `src/utils/clipboard.ts`

---

## 목차

1. [개요](#1-개요)
2. [클립보드 읽기](#2-클립보드-읽기)
3. [클립보드 쓰기](#3-클립보드-쓰기)
4. [권한 및 보안](#4-권한-및-보안)
5. [에러 처리](#5-에러-처리)
6. [사용 시나리오](#6-사용-시나리오)

---

## 1. 개요

### 1.1 목적

사용자가 복사한 텍스트를 자동으로 인식하고, 변환된 결과를 클립보드에 복사하는 기능을 제공합니다.

### 1.2 핵심 기능

- ✅ 클립보드 텍스트 자동 읽기
- ✅ 변환 결과 클립보드 복사
- ✅ 안전한 에러 처리
- ✅ 사용자 권한 관리

### 1.3 사용 API

**Clipboard API** (Web API)
- `navigator.clipboard.readText()`: 클립보드 읽기
- `navigator.clipboard.writeText()`: 클립보드 쓰기

**브라우저 지원**:
- ✅ Chrome 66+
- ✅ Edge 79+
- ✅ Firefox 63+
- ✅ Safari 13.1+

---

## 2. 클립보드 읽기

### 2.1 함수 스펙

```typescript
export async function readClipboard(): Promise<string>
```

**파라미터**: 없음

**반환값**: `Promise<string>`
- 성공: 클립보드의 텍스트 (trim된 상태)
- 실패: 빈 문자열 `''`

### 2.2 구현

```typescript
export async function readClipboard(): Promise<string> {
  try {
    // 1. Clipboard API 지원 확인
    if (!navigator.clipboard || !navigator.clipboard.readText) {
      throw new Error('클립보드 접근이 지원되지 않습니다.')
    }
    
    // 2. 클립보드 텍스트 읽기
    const text = await navigator.clipboard.readText()
    
    // 3. 앞뒤 공백 제거 후 반환
    return text.trim()
  } catch (error) {
    // 4. 에러 로그 (개발 모드에서만)
    console.error('Clipboard read error:', error)
    
    // 5. 빈 문자열 반환 (안전한 대체)
    return ''
  }
}
```

### 2.3 프로세스

```
사용자가 텍스트 복사 (Ctrl+C)
   ↓
클립보드에 텍스트 저장
   ↓
팝업 열림 (Extension 아이콘 클릭)
   ↓
readClipboard() 호출
   ↓
navigator.clipboard.readText()
   ↓
성공: 텍스트 반환
실패: 빈 문자열 반환
   ↓
텍스트 입력창에 자동 표시
```

### 2.4 호출 위치

**App.tsx (Popup)** - 팝업 초기화 시:
```typescript
const initializeApp = async () => {
  try {
    // 클립보드에서 텍스트 읽기
    const clipboardText = await readClipboard()
    
    setState(prev => ({
      ...prev,
      inputText: clipboardText
    }))
    
    // 클립보드에 텍스트가 있으면 자동 변환
    if (clipboardText) {
      await handleConvert(clipboardText)
    }
  } catch (error) {
    console.error('Initialization error:', error)
  }
}
```

**ActionBar.tsx** - "클립보드 읽기" 버튼 클릭 시:
```typescript
const handleReadClipboard = useCallback(async () => {
  try {
    const clipboardText = await readClipboard()
    
    setState(prev => ({
      ...prev,
      inputText: clipboardText,
      message: '',
      messageType: ''
    }))
    
    // 클립보드에 텍스트가 있으면 자동 변환
    if (clipboardText) {
      await handleConvert(clipboardText)
    }
  } catch (error) {
    console.error('Clipboard read error:', error)
    setState(prev => ({
      ...prev,
      message: '클립보드 읽기에 실패했습니다.',
      messageType: 'error'
    }))
  }
}, [])
```

### 2.5 에러 케이스

| 케이스 | 원인 | 결과 |
|--------|------|------|
| API 미지원 | 구버전 브라우저 | 빈 문자열 반환 |
| 권한 거부 | 사용자가 권한 거부 | 빈 문자열 반환 |
| 클립보드 비어있음 | 복사한 내용 없음 | 빈 문자열 반환 |
| 네트워크 오류 | 연결 문제 | 빈 문자열 반환 |

**모든 에러**: 빈 문자열 반환 (안전한 대체)

---

## 3. 클립보드 쓰기

### 3.1 함수 스펙

```typescript
export async function writeClipboard(text: string): Promise<void>
```

**파라미터**:
- `text: string` - 클립보드에 복사할 텍스트

**반환값**: `Promise<void>`
- 성공: 아무것도 반환하지 않음
- 실패: Error throw

### 3.2 구현

```typescript
export async function writeClipboard(text: string): Promise<void> {
  try {
    // 1. Clipboard API 지원 확인
    if (!navigator.clipboard || !navigator.clipboard.writeText) {
      throw new Error('클립보드 접근이 지원되지 않습니다.')
    }
    
    // 2. 클립보드에 텍스트 쓰기
    await navigator.clipboard.writeText(text)
  } catch (error) {
    // 3. 에러 로그
    console.error('Clipboard write error:', error)
    
    // 4. Error throw (상위에서 처리)
    throw new Error('클립보드 복사에 실패했습니다.')
  }
}
```

### 3.3 프로세스

```
변환 완료 또는 복사 버튼 클릭
   ↓
writeClipboard(text) 호출
   ↓
navigator.clipboard.writeText(text)
   ↓
성공: Promise resolve
실패: Error throw
   ↓
UI 피드백
   - 성공: 성공 메시지 또는 체크 아이콘
   - 실패: 에러 메시지
```

### 3.4 호출 위치

**App.tsx** - 자동 복사 (변환 완료 시):
```typescript
const handleConvert = async (text?: string) => {
  // ... API 호출 ...
  
  const results = await convertText(textToConvert, selectedProvider, apiKey)
  
  // 자동 복사 설정 확인 후 복사
  const autoCopyEnabled = await getAutoCopyEnabled()
  const autoCopyTone = await getAutoCopyTone()
  
  if (autoCopyEnabled) {
    const textToCopy = results[autoCopyTone]
    await writeClipboard(textToCopy)
    
    const toneNames = {
      formal: '비즈니스 이메일',
      general: '사내 메신저', 
      friendly: '캐주얼 채팅'
    }
    successMessage = `✅ ${toneNames[autoCopyTone]} 결과가 클립보드에 복사되었습니다!`
  }
}
```

**ResultCard.tsx** - 수동 복사 (복사 버튼 클릭 시):
```typescript
const handleCopy = async () => {
  try {
    await onCopy(text)  // → writeClipboard(text)
    
    // 복사 성공 표시
    setIsCopied(true)
    setTimeout(() => setIsCopied(false), 2000)
  } catch (error) {
    console.error('Copy failed:', error)
  }
}
```

### 3.5 에러 케이스

| 케이스 | 원인 | 처리 |
|--------|------|------|
| API 미지원 | 구버전 브라우저 | Error throw |
| 권한 거부 | 사용자가 권한 거부 | Error throw |
| 보안 제약 | HTTPS 미사용 | Error throw |
| 네트워크 오류 | 연결 문제 | Error throw |

**모든 에러**: Error throw (상위에서 처리)

---

## 4. 권한 및 보안

### 4.1 Chrome Extension 권한

**manifest.json**:
```json
{
  "permissions": [
    "clipboardRead",   // 클립보드 읽기 권한
    "clipboardWrite"   // 클립보드 쓰기 권한
  ]
}
```

### 4.2 권한 요청 시점

- ✅ Extension 설치 시 권한 요청
- ✅ 사용자가 승인해야 기능 사용 가능
- ❌ 런타임 권한 요청 없음 (Manifest V3)

### 4.3 보안 제약

**HTTPS Only**:
- Clipboard API는 HTTPS 환경에서만 동작
- 예외: `localhost` (개발 환경)

**사용자 제스처**:
- 클립보드 쓰기는 사용자 제스처 필요 (클릭 등)
- Extension에서는 자동으로 허용됨

**데이터 보안**:
- ✅ 클립보드 내용은 메모리에서만 사용
- ✅ 저장소에 저장하지 않음
- ✅ 네트워크로 전송 시 HTTPS 사용 (AI API 호출)
- ❌ 로그 출력 금지

---

## 5. 에러 처리

### 5.1 읽기 에러 처리

```typescript
// readClipboard()는 항상 성공 (빈 문자열 반환)
const clipboardText = await readClipboard()

if (!clipboardText) {
  // UI에 안내 메시지 표시
  setMessage('변환할 텍스트를 복사하거나, 직접 입력해주세요.')
}
```

### 5.2 쓰기 에러 처리

```typescript
// writeClipboard()는 실패 시 Error throw
try {
  await writeClipboard(text)
  // 성공 메시지
  setMessage('✅ 클립보드에 복사되었습니다!')
} catch (error) {
  // 에러 메시지
  setMessage('❌ 클립보드 복사에 실패했습니다.')
}
```

### 5.3 사용자 피드백

**읽기 성공**:
- 텍스트 입력창에 자동 표시
- 자동 변환 시작 (텍스트가 있을 때)

**읽기 실패**:
- 빈 입력창 표시
- 안내 메시지: "변환할 텍스트를 복사하거나, 직접 입력해주세요."

**쓰기 성공**:
- 체크 아이콘 표시 (2초간)
- 성공 메시지: "✅ [톤] 결과가 클립보드에 복사되었습니다!"

**쓰기 실패**:
- 에러 메시지: "❌ 클립보드 복사에 실패했습니다."

---

## 6. 사용 시나리오

### 6.1 시나리오 1: 자동 클립보드 읽기

```
1. 사용자가 이메일 작성 중
   "이번 주까지 꼭 전달 부탁드립니다."

2. 텍스트 선택 후 Ctrl+C 복사

3. Chrome 툴바의 Extension 아이콘 클릭

4. 팝업 열림
   - readClipboard() 자동 호출
   - 복사한 텍스트 입력창에 표시

5. 자동 변환 시작
   - AI API 호출
   - 3가지 톤 결과 표시

6. 자동 복사 (설정 시)
   - writeClipboard(results.formal)
   - 성공 메시지 표시
```

### 6.2 시나리오 2: 수동 클립보드 읽기

```
1. 팝업 이미 열려있음

2. 외부에서 새 텍스트 복사

3. "클립보드 읽기" 버튼 클릭

4. readClipboard() 호출
   - 새 텍스트 입력창에 표시

5. 자동 변환 시작
```

### 6.3 시나리오 3: 결과 수동 복사

```
1. 변환 결과 표시 중

2. 원하는 톤의 "복사하기" 버튼 클릭

3. writeClipboard(text) 호출

4. 성공
   - 체크 아이콘 표시 (2초)
   - 클립보드에 해당 톤의 결과 복사됨

5. 외부 앱으로 이동하여 Ctrl+V 붙여넣기
```

### 6.4 시나리오 4: 에러 케이스

```
1. 구버전 브라우저에서 팝업 열기

2. readClipboard() 호출
   - navigator.clipboard 미지원

3. 빈 문자열 반환
   - 에러 메시지 없음
   - 수동 입력 안내 표시

4. 사용자가 직접 텍스트 입력

5. 정상 동작
```

---

## 7. 성능 고려사항

### 7.1 응답 시간

| 작업 | 평균 시간 | 목표 |
|------|-----------|------|
| 클립보드 읽기 | 10-30ms | < 50ms |
| 클립보드 쓰기 | 5-15ms | < 50ms |

### 7.2 메모리 사용

- 클립보드 데이터는 메모리에서만 사용
- 저장소에 저장하지 않음
- 가비지 컬렉션 자동 처리

### 7.3 최적화

**불필요한 호출 방지**:
```typescript
// ✅ Good: 필요할 때만 호출
if (clipboardText) {
  await handleConvert(clipboardText)
}

// ❌ Bad: 무조건 호출
await handleConvert(clipboardText)
```

**에러 처리 최소화**:
```typescript
// readClipboard()는 항상 성공 (빈 문자열 반환)
// try-catch 불필요
const text = await readClipboard()
```

---

## 8. 테스트

### 8.1 단위 테스트

```typescript
describe('Clipboard Service', () => {
  test('클립보드 읽기 - 성공', async () => {
    // Mock navigator.clipboard
    global.navigator.clipboard = {
      readText: jest.fn().mockResolvedValue('test text')
    }
    
    const result = await readClipboard()
    expect(result).toBe('test text')
  })
  
  test('클립보드 읽기 - 공백 제거', async () => {
    global.navigator.clipboard = {
      readText: jest.fn().mockResolvedValue('  test  ')
    }
    
    const result = await readClipboard()
    expect(result).toBe('test')
  })
  
  test('클립보드 읽기 - 에러', async () => {
    global.navigator.clipboard = {
      readText: jest.fn().mockRejectedValue(new Error('Permission denied'))
    }
    
    const result = await readClipboard()
    expect(result).toBe('')
  })
  
  test('클립보드 쓰기 - 성공', async () => {
    const writeText = jest.fn().mockResolvedValue(undefined)
    global.navigator.clipboard = { writeText }
    
    await writeClipboard('test')
    expect(writeText).toHaveBeenCalledWith('test')
  })
  
  test('클립보드 쓰기 - 에러', async () => {
    global.navigator.clipboard = {
      writeText: jest.fn().mockRejectedValue(new Error('Permission denied'))
    }
    
    await expect(writeClipboard('test')).rejects.toThrow()
  })
})
```

### 8.2 통합 테스트

```typescript
describe('Clipboard Integration', () => {
  test('팝업 열기 → 클립보드 자동 읽기', async () => {
    // 1. 클립보드에 텍스트 설정
    await navigator.clipboard.writeText('test text')
    
    // 2. 팝업 초기화
    const { container } = render(<App />)
    await waitFor(() => {
      const input = container.querySelector('textarea')
      expect(input.value).toBe('test text')
    })
  })
  
  test('복사 버튼 클릭 → 클립보드 쓰기', async () => {
    const { container } = render(<ResultCard text="result" />)
    
    const copyButton = container.querySelector('[data-testid="copy-button"]')
    fireEvent.click(copyButton)
    
    await waitFor(() => {
      expect(navigator.clipboard.writeText).toHaveBeenCalledWith('result')
    })
  })
})
```

---

## 9. 개선 계획

### 9.1 단기 개선

1. **클립보드 변경 감지**
   - Clipboard API의 `clipboardchange` 이벤트 활용
   - 자동 새로고침 기능

2. **클립보드 히스토리**
   - 최근 복사한 텍스트 저장 (선택적)
   - 빠른 재사용

### 9.2 장기 개선

1. **다양한 형식 지원**
   - HTML 클립보드 지원
   - 이미지 내 텍스트 추출 (OCR)

2. **크로스 플랫폼**
   - Firefox, Safari Extension 지원

---

**문서 작성**: AI 코드 분석 시스템  
**최종 업데이트**: 2025-12-25

