# 기능 상세 스펙 문서 - 03. 텍스트 조작 및 메시징

> **문서 버전**: 2.5 (2026.01.05 Update)
> **작성일**: 2026-01-01
> **업데이트**: 2026-01-05 - Gemini 3.0 최적화 및 인스턴트 액션 고도화 반영
> **담당 모듈**: `src/content/`, `src/background/commands.ts`

---

## 1. 개요 (v2.5)

단순 클립보드 연동을 넘어, 사용자가 현재 활성화된 웹페이지에서 직접 텍스트를 선택하고 AI 기능을 실행할 수 있는 통합 텍스트 조작 시스템을 제공합니다.

---

## 2. 핵심 기능

### 2.1 텍스트 선택 및 대체 (Instant Replacement)
- **기능**: 웹페이지에서 블록 지정된 텍스트를 즉시 AI 변환 결과로 교체합니다.
- **구현**:
    - `GET_SELECTED_TEXT`: 현재 선택된 텍스트를 추출하고 로딩 상태를 표시합니다.
    - `REPLACE_SELECTED_TEXT`: AI 변환 결과를 기존 선택 영역에 삽입합니다. `contenteditable` 엘리먼트 및 표준 입력 폼(`input`, `textarea`)을 지원합니다.

### 2.2 백그라운드 명령어 (Global Commands)
- **단축키**: `manifest.json`에 정의된 전역 단축키를 통해 실행됩니다.
    - `instant-translation`: 선택 영역 즉시 번역 (기본 언어 설정 준수).
    - `instant-tone-conversion`: 선택 영역 즉시 톤 변환 (설정된 `instantToneStyle` 스타일 적용).
    - `tone-conversion`: 팝업 즉시 실행 및 클립보드 데이터 자동 로드.
- **메시지 버스**: Background Service Worker와 Content Script 간의 `chrome.tabs.sendMessage`를 통한 통신 체계.
- **하트비트**: 서비스 워커의 비정상 종료를 방지하기 위해 30초마다 `bca-heartbeat` 알람을 발생시켜 활성 상태 유지.

### 2.3 `tabs` 권한 사용 근거 (Permission Justification)
본 확장 프로그램은 원활한 사용자 경험과 웹페이지와의 직접적인 상호작용을 위해 `tabs` 권한을 다음과 같은 목적으로 사용합니다:
1. **현재 활성 탭 식별**: `chrome.tabs.query`를 사용하여 사용자가 단축키를 실행한 시점의 활성 탭 정보를 정확히 파악하고, 해당 페이지의 컨텍스트에서 작업을 수행합니다.
2. **컨텐츠 스크립트 통신**: `chrome.tabs.sendMessage`를 통해 배경(Background)과 웹페이지(Content Script) 간의 양방향 통신을 처리합니다. 이를 통해 선택된 텍스트를 가져오거나 변환된 결과를 페이지에 즉시 삽입합니다.
3. **사용자 편의 기능**: `chrome.tabs.create`를 활용하여 설정 페이지 내에서 단축키 설정 페이지(`chrome://extensions/shortcuts`) 등 외부 URL을 새 탭으로 여는 기능을 제공합니다.

---

## 3. 상세 프로세스

### 3.1 즉시 변환 흐름 (Background Logic)
1. **단축키 입력**: `chrome.commands.onCommand` 리스너 작동.
2. **상태 확인**: 현재 탭의 URL이 내부 페이지(`chrome://` 등)인지 확인.
3. **스크립트 주입**: 필요한 경우 `chrome.scripting.executeScript`를 통해 Content Script 동적 주입.
4. **텍스트 추출**: Content Script로부터 선택된 텍스트 수신.
5. **AI 실행**: `AIOrchestrator`를 통한 변환 수행.
6. **결과 적용**: 성공 시 Content Script에 대체 명령 전송, 실패 시 토스트 알림 표시.

---

## 4. UI/UX 피드백

### 4.1 로딩 표시
- 텍스트 선택 시 `bca-selection-loading` 아이디를 가진 오버레이를 생성하여 처리 중임을 사용자에게 알립니다.

### 4.2 토스트 알림 (Toast)
- 백그라운드에서 발생한 에러(API 키 오류, 네트워크 문제 등)를 사용자 페이지 상단에 세련된 토스트 UI로 표시합니다. (`src/content/toast.ts`)

---

## 5. 보안 가이드라인

- **데이터 최소 노출**: 사용자가 선택한 텍스트는 변환 목적으로만 사용되며, 로컬 스토리지에 저장되지 않습니다.
- **안전한 DOM 접근**: `execCommand('insertText')` 또는 최신 Selection API를 사용하여 브라우저의 보안 정책을 준수하며 텍스트를 대체합니다.

---

**문서 업데이트**: 2026-01-01
