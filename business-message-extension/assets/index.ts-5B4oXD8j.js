import{d as t,A as e}from"./crypto-DogMPkOD.js";import{g as a,l as i}from"./storage-DQogxH6w.js";function n(t){return/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(t)?"ko":/[\u3040-\u309F|\u30A0-\u30FF]/.test(t)?"ja":/[\u4E00-\u9FFF]/.test(t)?"zh":"en"}async function r(t,e){try{const a=await async function(t){try{const e=await chrome.tabs.sendMessage(t,{action:"PING"});return"pong"===e?.message}catch(e){try{return await chrome.scripting.executeScript({target:{tabId:t},files:["src/content/index.ts"]}),await new Promise(t=>setTimeout(t,150)),!0}catch(a){return!1}}}(t);return a?await chrome.tabs.sendMessage(t,e):null}catch(a){return"SHOW_TOAST"===e.action&&chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"error"===e.type?"BCA 오류":"BCA 알림",message:e.message}),null}}chrome.commands.onCommand.addListener(async o=>{try{if("instant-translation"===o)await async function(){const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(o?.id&&!(o.url?.startsWith("chrome://")||o.url?.startsWith("edge://")||o.url?.startsWith("about:")))try{const s=await r(o.id,{action:"GET_SELECTED_TEXT"});if(null===s)return void chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"BCA 알림",message:"현재 페이지에서 기능을 실행할 수 없습니다. 페이지를 새로고침하거나 다른 페이지에서 시도해주세요."});const c=s.text;if(!c||""===c.trim())return void(await r(o.id,{action:"SHOW_TOAST",message:"번역할 텍스트를 선택해주세요.",type:"info"}));const d=await a(),{settings:u,apiKeys:l}=d,g=await async function(a,i,r,o){const s=r.selectedProvider,c=r.providerModels[s],d=o[s];if(!d)return{success:!1,translatedText:"",detectedLanguage:"",error:`${s} API 키가 설정되지 않았습니다.`};try{const r=await t(d);return{success:!0,translatedText:await e.execute(a,"translation",{provider:s,model:c,apiKey:r,targetLanguage:i}),detectedLanguage:n(a)}}catch(u){return{success:!1,translatedText:"",detectedLanguage:"",error:u.message}}}(c,u.translation.defaultTargetLanguage,u,l);g.success?(await r(o.id,{action:"REPLACE_SELECTED_TEXT",text:g.translatedText}),await i({provider:u.selectedProvider,model:u.providerModels[u.selectedProvider],task:"translation",inputTokens:Math.ceil(.75*c.length),outputTokens:Math.ceil(.75*g.translatedText.length)})):(await r(o.id,{action:"REMOVE_LOADING"}),await r(o.id,{action:"SHOW_TOAST",message:g.error||"번역에 실패했습니다.",type:"error"}))}catch(s){o?.id&&(await r(o.id,{action:"REMOVE_LOADING"}),await r(o.id,{action:"SHOW_TOAST",message:s.message||"번역 중 오류가 발생했습니다.",type:"error"}))}}();else if("instant-tone-conversion"===o)await async function(){const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(n?.id&&!(n.url?.startsWith("chrome://")||n.url?.startsWith("edge://")||n.url?.startsWith("about:")))try{const o=await r(n.id,{action:"GET_SELECTED_TEXT"});if(null===o)return void chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"BCA 알림",message:"현재 페이지에서 기능을 실행할 수 없습니다. 페이지를 새로고침하거나 다른 페이지에서 시도해주세요."});const s=o.text;if(!s||""===s.trim())return void(await r(n.id,{action:"SHOW_TOAST",message:"변환할 텍스트를 선택해주세요.",type:"info"}));const c=await a(),{settings:d,apiKeys:u}=c,l=d.selectedProvider,g=d.providerModels[l],m=u[l];if(!m)return void(await r(n.id,{action:"SHOW_TOAST",message:`${l} API 키가 설정되지 않았습니다.`,type:"error"}));const p=await t(m),w=d.instantToneStyle||"formal",h=(await e.execute(s,"tone-conversion",{provider:l,model:g,apiKey:p,tone:w}))[w];if(!h)throw new Error("변환된 텍스트를 생성하지 못했습니다.");await r(n.id,{action:"REPLACE_SELECTED_TEXT",text:h}),await i({provider:l,model:g,task:"tone-conversion",inputTokens:Math.ceil(.75*s.length),outputTokens:Math.ceil(.75*h.length)})}catch(o){n?.id&&(await r(n.id,{action:"REMOVE_LOADING"}),await r(n.id,{action:"SHOW_TOAST",message:o.message||"변환에 실패했습니다.",type:"error"}))}}();else if(("_execute_action"===o||"tone-conversion"===o)&&(await chrome.storage.local.set({lastCommand:"tone-conversion",commandTimestamp:Date.now()}),"tone-conversion"===o))try{chrome.action&&"function"==typeof chrome.action.openPopup&&await chrome.action.openPopup()}catch(s){}}catch(c){}}),chrome.runtime.onMessage.addListener((i,n,r)=>"CALL_AI_API"===i.action&&(async function(i){try{const n=await a(),{settings:r,apiKeys:o}=n,s=r.selectedProvider,c=r.providerModels[s],d=o[s];if(!d)throw new Error(`${s} API 키가 설정되지 않았습니다.`);const u=await t(d),l=i.targetLanguage||r.translation.defaultTargetLanguage;return{success:!0,data:await e.execute(i.text,i.task,{provider:s,model:c,apiKey:u,targetLanguage:l})}}catch(n){return{success:!1,error:n.message}}}(i.payload).then(r),!0));
