import{g as t,l as e}from"./storage-BHZ9Hasj.js";import{d as a,A as o}from"./ai-orchestrator-aGs9CcqA.js";async function n(t,e){try{const a=await async function(t){try{const e=await chrome.tabs.sendMessage(t,{action:"PING"});return"pong"===e?.message}catch(e){return!1}}(t);if(!a)throw new Error("Content script not ready");return await chrome.tabs.sendMessage(t,e)}catch(a){return"SHOW_TOAST"===e.action&&chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"error"===e.type?"BCA 오류":"BCA 알림",message:e.message}),null}}async function i(){await chrome.alarms.get("bca-heartbeat")||chrome.alarms.create("bca-heartbeat",{periodInMinutes:.5})}chrome.runtime.onInstalled.addListener(t=>{"install"===t.reason||t.reason,i()}),i(),chrome.alarms.onAlarm.addListener(t=>{t.name}),chrome.commands.onCommand.addListener(async i=>{try{if("instant-tone-conversion"===i)await async function(){const[i]=await chrome.tabs.query({active:!0,currentWindow:!0});if(i?.id&&!(i.url?.startsWith("chrome://")||i.url?.startsWith("edge://")||i.url?.startsWith("about:")))try{const r=await n(i.id,{action:"GET_SELECTED_TEXT"});if(null===r)return void chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"BCA 알림",message:"현재 페이지에서 기능을 실행할 수 없습니다. 페이지를 새로고침하거나 다른 페이지에서 시도해주세요."});const s=r.text;if(!s||""===s.trim())return void(await n(i.id,{action:"SHOW_TOAST",message:"변환할 텍스트를 선택해주세요.",type:"info"}));const c=await t(),{settings:m,apiKeys:d}=c,l=m.selectedProvider,h=m.providerModels[l],u=d[l];if(!u)return void(await n(i.id,{action:"SHOW_TOAST",message:`${l} API 키가 설정되지 않았습니다.`,type:"error"}));const p=await a(u),w=m.instantToneStyle||"formal",g=(await o.execute(s,"tone-conversion",{provider:l,model:h,apiKey:p,tone:w}))[w];if(!g)throw new Error("변환된 텍스트를 생성하지 못했습니다.");await n(i.id,{action:"REPLACE_SELECTED_TEXT",text:g}),await e({provider:l,model:h,task:"tone-conversion",inputTokens:Math.ceil(.75*s.length),outputTokens:Math.ceil(.75*g.length)})}catch(r){i?.id&&(await n(i.id,{action:"REMOVE_LOADING"}),await n(i.id,{action:"SHOW_TOAST",message:r.message||"변환에 실패했습니다.",type:"error"}))}}();else if(("_execute_action"===i||"tone-conversion"===i)&&(await chrome.storage.local.set({lastCommand:"tone-conversion",commandTimestamp:Date.now()}),"tone-conversion"===i))try{chrome.action&&"function"==typeof chrome.action.openPopup&&await chrome.action.openPopup()}catch(r){}}catch(s){}}),chrome.runtime.onMessage.addListener((t,e,a)=>"PING_BKG"===t.action&&(a({status:"active",timestamp:Date.now()}),!0));
