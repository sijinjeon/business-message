import{d as t,A as e}from"./crypto-ex6r7ieV.js";import{g as a,l as n}from"./storage-Ce3jUJWf.js";function o(t){return/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(t)?"ko":/[\u3040-\u309F|\u30A0-\u30FF]/.test(t)?"ja":/[\u4E00-\u9FFF]/.test(t)?"zh":"en"}async function i(t,e){try{return await chrome.tabs.sendMessage(t,e)}catch(a){return null}}chrome.action.onClicked.addListener(async()=>{await chrome.storage.local.set({lastCommand:"_execute_action",commandTimestamp:Date.now()}),await chrome.action.openPopup()}),chrome.commands.onCommand.addListener(async r=>{"instant-translation"===r?await async function(){const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(r?.id)try{const s=await i(r.id,{action:"GET_SELECTED_TEXT"}),c=s?.text;if(!c)return;const d=await a(),{settings:u,apiKeys:l}=d,m=await async function(a,n,i,r){const s=i.selectedProvider,c=i.providerModels[s],d=r[s];if(!d)return{success:!1,translatedText:"",detectedLanguage:"",error:`${s} API 키가 설정되지 않았습니다.`};try{const i=await t(d);return{success:!0,translatedText:await e.execute(a,"translation",{provider:s,model:c,apiKey:i,targetLanguage:n}),detectedLanguage:o(a)}}catch(u){return{success:!1,translatedText:"",detectedLanguage:"",error:u.message}}}(c,u.translation.defaultTargetLanguage,u,l);m.success?(await i(r.id,{action:"REPLACE_SELECTED_TEXT",text:m.translatedText}),await n({provider:u.selectedProvider,model:u.providerModels[u.selectedProvider],task:"translation",inputTokens:Math.ceil(.75*c.length),outputTokens:Math.ceil(.75*m.translatedText.length)})):(await i(r.id,{action:"REMOVE_LOADING"}),await i(r.id,{action:"SHOW_TOAST",message:m.error||"번역에 실패했습니다.",type:"error"}))}catch(s){r?.id&&await i(r.id,{action:"REMOVE_LOADING"})}}():"instant-tone-conversion"===r?await async function(){const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(o?.id)try{const r=await i(o.id,{action:"GET_SELECTED_TEXT"}),s=r?.text;if(!s)return;const c=await a(),{settings:d,apiKeys:u}=c,l=d.selectedProvider,m=d.providerModels[l],g=u[l];if(!g)return void(await i(o.id,{action:"SHOW_TOAST",message:`${l} API 키가 설정되지 않았습니다.`,type:"error"}));const w=await t(g),p=await e.execute(s,"tone-conversion",{provider:l,model:m,apiKey:w}),T=p[d.instantToneStyle||"formal"];await i(o.id,{action:"REPLACE_SELECTED_TEXT",text:T}),await n({provider:l,model:m,task:"tone-conversion",inputTokens:Math.ceil(.75*s.length),outputTokens:Math.ceil(.75*T.length)})}catch(r){o?.id&&(await i(o.id,{action:"REMOVE_LOADING"}),await i(o.id,{action:"SHOW_TOAST",message:r.message||"변환에 실패했습니다.",type:"error"}))}}():"tone-conversion"===r?(await chrome.storage.local.set({lastCommand:"tone-conversion",commandTimestamp:Date.now()}),await chrome.action.openPopup()):"_execute_action"===r&&await chrome.storage.local.set({lastCommand:"_execute_action",commandTimestamp:Date.now()})}),chrome.runtime.onMessage.addListener((n,o,i)=>"CALL_AI_API"===n.action&&(async function(n){try{const o=await a(),{settings:i,apiKeys:r}=o,s=i.selectedProvider,c=i.providerModels[s],d=r[s];if(!d)throw new Error(`${s} API 키가 설정되지 않았습니다.`);const u=await t(d),l=n.targetLanguage||i.translation.defaultTargetLanguage;return{success:!0,data:await e.execute(n.text,n.task,{provider:s,model:c,apiKey:u,targetLanguage:l})}}catch(o){return{success:!1,error:o.message}}}(n.payload).then(i),!0));
