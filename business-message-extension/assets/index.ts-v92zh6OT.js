import{d as e,A as t}from"./crypto-DogMPkOD.js";import{g as a,l as n}from"./storage-DQogxH6w.js";function i(e){return/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(e)?"ko":/[\u3040-\u309F|\u30A0-\u30FF]/.test(e)?"ja":/[\u4E00-\u9FFF]/.test(e)?"zh":"en"}function o(e){if(!e)return!0;return["chrome://","chrome-extension://","edge://","about:","moz-extension://","file://","chrome.google.com/webstore","addons.mozilla.org"].some(t=>e.startsWith(t)||e.includes(t))}function r(e,t="info"){const a="error"===t?"BCA 오류":"success"===t?"BCA 완료":"BCA 알림";chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:a,message:e})}async function s(e,t){try{const a=await async function(e){try{const t=await chrome.tabs.sendMessage(e,{action:"PING"});return"pong"===t?.message}catch(t){try{await chrome.scripting.insertCSS({target:{tabId:e},files:["styles/global.css"]}),await chrome.scripting.executeScript({target:{tabId:e},files:["scripts/content.js"]}),await new Promise(e=>setTimeout(e,200));try{const t=await chrome.tabs.sendMessage(e,{action:"PING"});return"pong"===t?.message}catch{return!1}}catch(a){return a.message?.includes("Cannot access"),!1}}}(e);if(!a)throw new Error("Content script not ready");return await chrome.tabs.sendMessage(e,t)}catch(a){return"SHOW_TOAST"===t.action&&chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"error"===t.type?"BCA 오류":"BCA 알림",message:t.message}),null}}const c=Date.now();async function d(){try{const e=await chrome.commands.getAll();e.filter(e=>!e.shortcut&&"_execute_action"!==e.name).length}catch(e){}}async function m(){try{await chrome.alarms.get("bca-heartbeat")||await chrome.alarms.create("bca-heartbeat",{periodInMinutes:.5})}catch(e){}}chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason||e.reason,m(),d()}),m(),chrome.alarms.onAlarm.addListener(e=>{if("bca-heartbeat"===e.name){Math.round((Date.now()-c)/1e3)}}),chrome.commands.getAll().then(e=>{}),chrome.commands.onCommand.addListener(async c=>{try{if("instant-translation"===c)await async function(){const[c]=await chrome.tabs.query({active:!0,currentWindow:!0});if(c?.id)if(o(c.url))r("브라우저 내부 페이지에서는 BCA를 사용할 수 없습니다.","info");else try{const o=await s(c.id,{action:"GET_SELECTED_TEXT"});if(null===o)return void chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"BCA 알림",message:"현재 페이지에서 기능을 실행할 수 없습니다. 페이지를 새로고침하거나 다른 페이지에서 시도해주세요."});const r=o.text;if(!r||""===r.trim())return void(await s(c.id,{action:"SHOW_TOAST",message:"번역할 텍스트를 선택해주세요.",type:"info"}));const d=await a(),{settings:m,apiKeys:l}=d,u=await async function(a,n,o,r){const s=o.selectedProvider,c=o.providerModels[s],d=r[s];if(!d)return{success:!1,translatedText:"",detectedLanguage:"",error:`${s} API 키가 설정되지 않았습니다.`};try{const o=await e(d);return{success:!0,translatedText:await t.execute(a,"translation",{provider:s,model:c,apiKey:o,targetLanguage:n}),detectedLanguage:i(a)}}catch(m){return{success:!1,translatedText:"",detectedLanguage:"",error:m.message}}}(r,m.translation.defaultTargetLanguage,m,l);u.success?(await s(c.id,{action:"REPLACE_SELECTED_TEXT",text:u.translatedText,append:!0}),await n({provider:m.selectedProvider,model:m.providerModels[m.selectedProvider],task:"translation",inputTokens:Math.ceil(.75*r.length),outputTokens:Math.ceil(.75*u.translatedText.length)})):(await s(c.id,{action:"REMOVE_LOADING"}),await s(c.id,{action:"SHOW_TOAST",message:u.error||"번역에 실패했습니다.",type:"error"}))}catch(d){c?.id&&(await s(c.id,{action:"REMOVE_LOADING"}),await s(c.id,{action:"SHOW_TOAST",message:d.message||"번역 중 오류가 발생했습니다.",type:"error"}))}else r("활성 탭을 찾을 수 없습니다.","error")}();else if("instant-tone-conversion"===c)await async function(){const[i]=await chrome.tabs.query({active:!0,currentWindow:!0});if(i?.id)if(o(i.url))r("브라우저 내부 페이지에서는 BCA를 사용할 수 없습니다.","info");else try{const o=await s(i.id,{action:"GET_SELECTED_TEXT"});if(null===o)return void chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"BCA 알림",message:"현재 페이지에서 기능을 실행할 수 없습니다. 페이지를 새로고침하거나 다른 페이지에서 시도해주세요."});const r=o.text;if(!r||""===r.trim())return void(await s(i.id,{action:"SHOW_TOAST",message:"변환할 텍스트를 선택해주세요.",type:"info"}));const c=await a(),{settings:d,apiKeys:m}=c,l=d.selectedProvider,u=d.providerModels[l],g=m[l];if(!g)return void(await s(i.id,{action:"SHOW_TOAST",message:`${l} API 키가 설정되지 않았습니다.`,type:"error"}));const h=await e(g),p=d.instantToneStyle||"formal",w=(await t.execute(r,"tone-conversion",{provider:l,model:u,apiKey:h,tone:p}))[p];if(!w)throw new Error("변환된 텍스트를 생성하지 못했습니다.");await s(i.id,{action:"REPLACE_SELECTED_TEXT",text:w}),await n({provider:l,model:u,task:"tone-conversion",inputTokens:Math.ceil(.75*r.length),outputTokens:Math.ceil(.75*w.length)})}catch(c){i?.id&&(await s(i.id,{action:"REMOVE_LOADING"}),await s(i.id,{action:"SHOW_TOAST",message:c.message||"변환에 실패했습니다.",type:"error"}))}else r("활성 탭을 찾을 수 없습니다.","error")}();else if(("_execute_action"===c||"tone-conversion"===c)&&(await chrome.storage.local.set({lastCommand:"tone-conversion",commandTimestamp:Date.now()}),"tone-conversion"===c))try{chrome.action&&"function"==typeof chrome.action.openPopup&&await chrome.action.openPopup()}catch(d){}}catch(m){}}),d(),chrome.runtime.onMessage.addListener((n,i,o)=>"CALL_AI_API"===n.action?(async function(n){try{const i=await a(),{settings:o,apiKeys:r}=i,s=o.selectedProvider,c=o.providerModels[s],d=r[s];if(!d)throw new Error(`${s} API 키가 설정되지 않았습니다.`);const m=await e(d),l=n.targetLanguage||o.translation.defaultTargetLanguage;return{success:!0,data:await t.execute(n.text,n.task,{provider:s,model:c,apiKey:m,targetLanguage:l})}}catch(i){return{success:!1,error:i.message}}}(n.payload).then(o),!0):"PING_BKG"===n.action&&(o({status:"active",timestamp:Date.now()}),!0));
