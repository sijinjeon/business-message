# 기능 상세 스펙 문서 - 06. 데이터베이스 및 스토리지

> **문서 버전**: 1.0  
> **작성일**: 2025-12-25  
> **담당 모듈**: `src/utils/storage.ts`, Chrome Storage API

---

## 목차

1. [개요](#1-개요)
2. [데이터베이스 아키텍처](#2-데이터베이스-아키텍처)
3. [데이터 스키마](#3-데이터-스키마)
4. [CRUD 연산](#4-crud-연산)
5. [데이터 마이그레이션](#5-데이터-마이그레이션)
6. [백업 및 복구](#6-백업-및-복구)
7. [성능 및 제한사항](#7-성능-및-제한사항)

---

## 1. 개요

### 1.1 스토리지 시스템

**사용 기술**: Chrome Storage API (Local Storage)

**선택 이유**:
- ✅ Chrome Extension 표준 스토리지
- ✅ 비동기 API 제공
- ✅ 자동 직렬화/역직렬화
- ✅ 브라우저 로컬에만 저장 (보안)
- ✅ 5MB 용량 제한 (충분함)

**대체 기술 비교**:

| 기술 | 장점 | 단점 | 채택 여부 |
|------|------|------|-----------|
| **Chrome Storage Local** | 비동기, 안전, 표준 | 5MB 제한 | ✅ 채택 |
| LocalStorage | 동기, 간단 | 5MB 제한, 동기 블로킹 | ❌ |
| IndexedDB | 대용량, 구조화 | 복잡한 API, 과한 스펙 | ❌ |
| Chrome Storage Sync | 동기화 가능 | 보안 이슈, 100KB 제한 | ❌ |

### 1.2 핵심 요구사항

- ✅ API 키 안전 저장 (암호화)
- ✅ 사용자 설정 관리
- ✅ 사용량 추적
- ✅ 제공업체별 독립적 데이터 관리
- ✅ 데이터 마이그레이션 지원

---

## 2. 데이터베이스 아키텍처

### 2.1 스토리지 구조

```
Chrome Storage Local
├── apiKeys (Object)
│   ├── gemini: string (encrypted)
│   ├── chatgpt: string (encrypted)
│   └── claude: string (encrypted)
├── dailyUsage (Object)
│   ├── date: string (YYYY-MM-DD)
│   └── count: number
└── settings (Object)
    ├── selectedProvider: string ('gemini' | 'chatgpt' | 'claude')
    ├── preferredModel: string
    ├── temperature: number (0.1-1.0)
    ├── maxOutputTokens: number
    ├── autoCopyEnabled: boolean
    └── autoCopyTone: string ('formal' | 'general' | 'friendly')
```

### 2.2 ERD (Entity Relationship Diagram)

```
┌─────────────────────────┐
│      AppStorage         │
├─────────────────────────┤
│ apiKeys                 │──┐
│ dailyUsage              │  │
│ settings                │  │
└─────────────────────────┘  │
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ↓                    ↓                    ↓
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│   ApiKeys    │   │ DailyUsage   │   │  Settings    │
├──────────────┤   ├──────────────┤   ├──────────────┤
│ gemini       │   │ date         │   │ selected     │
│ chatgpt      │   │ count        │   │ Provider     │
│ claude       │   └──────────────┘   │ preferred    │
└──────────────┘                      │ Model        │
                                      │ temperature  │
                                      │ maxOutput    │
                                      │ Tokens       │
                                      │ autoCopy     │
                                      │ Enabled      │
                                      │ autoCopyTone │
                                      └──────────────┘
```

### 2.3 데이터 접근 패턴

**읽기 패턴**:
```
1. 팝업 열기
   → getStorageData() (전체 데이터 조회)
   → getSelectedProvider()
   → getCurrentApiKey()
   
2. 설정 페이지 열기
   → getStorageData()
   → getApiKey(provider) (각 제공업체별)
   → getAutoCopyEnabled()
   → getAutoCopyTone()
```

**쓰기 패턴**:
```
1. API 키 저장
   → saveApiKey(provider, apiKey)
   → crypto.encryptData()
   → setStorageData({ apiKeys })
   
2. 설정 변경
   → setSelectedProvider(provider)
   → setAutoCopyEnabled(boolean)
   → setAutoCopyTone(tone)
   
3. 사용량 증가
   → updateDailyUsage()
   → setStorageData({ dailyUsage })
```

---

## 3. 데이터 스키마

### 3.1 TypeScript 인터페이스

```typescript
// src/types/index.ts

export type AIProvider = 'gemini' | 'chatgpt' | 'claude';

export interface AppStorage {
  apiKeys: {
    gemini: string;    // AES-GCM 암호화된 Base64 문자열
    chatgpt: string;   // AES-GCM 암호화된 Base64 문자열
    claude: string;    // AES-GCM 암호화된 Base64 문자열
  };
  dailyUsage: {
    date: string;      // ISO 8601 형식 (YYYY-MM-DD)
    count: number;     // 0 이상의 정수
  };
  settings: {
    selectedProvider: AIProvider;           // 현재 선택된 AI 제공업체
    preferredModel: string;                 // 모델 이름 (향후 확장용)
    temperature: number;                    // 0.1 ~ 1.0
    maxOutputTokens: number;                // 최대 출력 토큰 수
    autoCopyEnabled: boolean;               // 자동 복사 활성화 여부
    autoCopyTone: 'formal' | 'general' | 'friendly';  // 자동 복사할 톤
  };
}
```

### 3.2 필드 상세 명세

#### apiKeys

**타입**: `Object`

| 필드 | 타입 | 필수 | 기본값 | 설명 |
|------|------|------|--------|------|
| `gemini` | `string` | ✅ | `''` | 암호화된 Gemini API 키 |
| `chatgpt` | `string` | ✅ | `''` | 암호화된 OpenAI API 키 |
| `claude` | `string` | ✅ | `''` | 암호화된 Claude API 키 |

**제약조건**:
- 빈 문자열 또는 암호화된 Base64 문자열만 허용
- 평문 API 키 저장 금지
- 암호화 형식: `Base64(IV[12] + Ciphertext + AuthTag[16])`

**예시**:
```json
{
  "apiKeys": {
    "gemini": "xK7j9mP1q2w3e4r5t6y7u8i9o0p1ENCRYPTED==",
    "chatgpt": "",
    "claude": ""
  }
}
```

#### dailyUsage

**타입**: `Object`

| 필드 | 타입 | 필수 | 기본값 | 설명 |
|------|------|------|--------|------|
| `date` | `string` | ✅ | 오늘 날짜 | ISO 8601 형식 (YYYY-MM-DD) |
| `count` | `number` | ✅ | `0` | 오늘 사용 횟수 (0 이상) |

**제약조건**:
- `date`는 'YYYY-MM-DD' 형식만 허용
- `count`는 0 이상의 정수
- 최대값: 50 (일일 제한)

**로직**:
```typescript
// 사용량 확인
const today = new Date().toISOString().split('T')[0]
if (dailyUsage.date !== today) {
  // 새로운 날 → 카운터 리셋
  count = 0
  date = today
}
```

**예시**:
```json
{
  "dailyUsage": {
    "date": "2025-12-25",
    "count": 5
  }
}
```

#### settings

**타입**: `Object`

| 필드 | 타입 | 필수 | 기본값 | 설명 |
|------|------|------|--------|------|
| `selectedProvider` | `AIProvider` | ✅ | `'gemini'` | 현재 선택된 AI 제공업체 |
| `preferredModel` | `string` | ✅ | `'gemini-2.0-flash-exp'` | 선호 모델 (향후 확장) |
| `temperature` | `number` | ✅ | `0.7` | AI 생성 온도 (0.1-1.0) |
| `maxOutputTokens` | `number` | ✅ | `1024` | 최대 출력 토큰 수 |
| `autoCopyEnabled` | `boolean` | ✅ | `true` | 자동 복사 활성화 |
| `autoCopyTone` | `string` | ✅ | `'formal'` | 자동 복사할 톤 |

**제약조건**:
- `selectedProvider`: 'gemini' | 'chatgpt' | 'claude'만 허용
- `temperature`: 0.1 ~ 1.0 범위
- `maxOutputTokens`: 100 ~ 4096 범위
- `autoCopyTone`: 'formal' | 'general' | 'friendly'만 허용

**예시**:
```json
{
  "settings": {
    "selectedProvider": "gemini",
    "preferredModel": "gemini-2.0-flash-exp",
    "temperature": 0.7,
    "maxOutputTokens": 1024,
    "autoCopyEnabled": true,
    "autoCopyTone": "formal"
  }
}
```

### 3.3 기본값 (DEFAULT_STORAGE)

```typescript
const DEFAULT_STORAGE: AppStorage = {
  apiKeys: {
    gemini: '',
    chatgpt: '',
    claude: ''
  },
  dailyUsage: {
    date: new Date().toISOString().split('T')[0],  // 오늘 날짜
    count: 0
  },
  settings: {
    selectedProvider: 'gemini',
    preferredModel: 'gemini-2.0-flash-exp',
    temperature: 0.7,
    maxOutputTokens: 1024,
    autoCopyEnabled: true,
    autoCopyTone: 'formal'
  }
}
```

---

## 4. CRUD 연산

### 4.1 Read (조회)

**전체 데이터 조회**:
```typescript
export async function getStorageData(): Promise<AppStorage> {
  try {
    const result = await chrome.storage.local.get(null)
    
    // 마이그레이션 로직 (v1.0 이전 버전 호환)
    if (result.userApiKey && !result.apiKeys?.gemini) {
      const migratedData = {
        ...DEFAULT_STORAGE,
        ...result,
        apiKeys: {
          gemini: result.userApiKey,
          chatgpt: '',
          claude: ''
        }
      }
      delete (migratedData as any).userApiKey
      await chrome.storage.local.set(migratedData)
      return migratedData
    }
    
    return { ...DEFAULT_STORAGE, ...result }
  } catch (error) {
    console.error('Storage read error:', error)
    return DEFAULT_STORAGE
  }
}
```

**특정 필드 조회**:
```typescript
// 선택된 제공업체
export async function getSelectedProvider(): Promise<AIProvider> {
  const data = await getStorageData()
  return data.settings.selectedProvider
}

// API 키 (복호화)
export async function getApiKey(provider: AIProvider): Promise<string> {
  const data = await getStorageData()
  if (!data.apiKeys[provider]) return ''
  
  const { decryptData } = await import('./crypto')
  try {
    return await decryptData(data.apiKeys[provider])
  } catch {
    return ''  // 복호화 실패 시 안전한 대체
  }
}

// 자동 복사 설정
export async function getAutoCopyEnabled(): Promise<boolean> {
  const data = await getStorageData()
  return data.settings.autoCopyEnabled
}

// 자동 복사 톤
export async function getAutoCopyTone(): Promise<'formal' | 'general' | 'friendly'> {
  const data = await getStorageData()
  return data.settings.autoCopyTone
}

// 남은 사용 횟수
export async function getRemainingUsage(): Promise<number> {
  const data = await getStorageData()
  const today = new Date().toISOString().split('T')[0]
  
  if (data.dailyUsage.date !== today) {
    return 50  // 새로운 날
  }
  
  return Math.max(0, 50 - data.dailyUsage.count)
}
```

### 4.2 Create / Update (생성 / 수정)

**기본 쓰기 함수**:
```typescript
export async function setStorageData(
  data: Partial<AppStorage>
): Promise<void> {
  try {
    await chrome.storage.local.set(data)
  } catch (error) {
    console.error('Storage write error:', error)
    throw new Error('데이터 저장에 실패했습니다.')
  }
}
```

**API 키 저장** (암호화):
```typescript
export async function saveApiKey(
  provider: AIProvider, 
  apiKey: string
): Promise<void> {
  // 1. 암호화
  const { encryptData } = await import('./crypto')
  const encryptedKey = await encryptData(apiKey)
  
  // 2. 기존 데이터 조회
  const data = await getStorageData()
  
  // 3. 업데이트 (해당 제공업체만)
  await setStorageData({ 
    apiKeys: {
      ...data.apiKeys,
      [provider]: encryptedKey
    }
  })
}
```

**제공업체 선택 저장**:
```typescript
export async function setSelectedProvider(
  provider: AIProvider
): Promise<void> {
  const data = await getStorageData()
  await setStorageData({
    settings: {
      ...data.settings,
      selectedProvider: provider
    }
  })
}
```

**자동 복사 설정**:
```typescript
export async function setAutoCopyEnabled(
  enabled: boolean
): Promise<void> {
  const data = await getStorageData()
  await setStorageData({
    settings: {
      ...data.settings,
      autoCopyEnabled: enabled
    }
  })
}

export async function setAutoCopyTone(
  tone: 'formal' | 'general' | 'friendly'
): Promise<void> {
  const data = await getStorageData()
  await setStorageData({
    settings: {
      ...data.settings,
      autoCopyTone: tone
    }
  })
}
```

**사용량 업데이트**:
```typescript
export async function updateDailyUsage(): Promise<number> {
  const data = await getStorageData()
  const today = new Date().toISOString().split('T')[0]
  
  let newCount = 1
  if (data.dailyUsage.date === today) {
    newCount = data.dailyUsage.count + 1
  }
  
  await setStorageData({
    dailyUsage: {
      date: today,
      count: newCount
    }
  })
  
  return newCount
}
```

### 4.3 Delete (삭제)

**API 키 삭제**:
```typescript
export async function deleteApiKey(
  provider: AIProvider
): Promise<void> {
  const data = await getStorageData()
  await setStorageData({ 
    apiKeys: {
      ...data.apiKeys,
      [provider]: ''  // 빈 문자열로 설정
    }
  })
}
```

**전체 데이터 삭제** (리셋):
```typescript
export async function clearAllData(): Promise<void> {
  await chrome.storage.local.clear()
}
```

---

## 5. 데이터 마이그레이션

### 5.1 버전 히스토리

**v0.x → v1.0**:
- `userApiKey` (단일 필드) → `apiKeys` (객체)
- Gemini만 지원 → 3개 제공업체 지원

### 5.2 마이그레이션 로직

```typescript
export async function getStorageData(): Promise<AppStorage> {
  try {
    const result = await chrome.storage.local.get(null)
    
    // v0.x 데이터 감지
    if (result.userApiKey && !result.apiKeys?.gemini) {
      console.log('Migrating from v0.x to v1.0...')
      
      const migratedData = {
        ...DEFAULT_STORAGE,
        ...result,
        apiKeys: {
          gemini: result.userApiKey,  // 기존 키를 gemini로 이동
          chatgpt: '',
          claude: ''
        }
      }
      
      // 구버전 필드 제거
      delete (migratedData as any).userApiKey
      
      // 새 형식으로 저장
      await chrome.storage.local.set(migratedData)
      
      console.log('Migration completed successfully')
      return migratedData
    }
    
    return { ...DEFAULT_STORAGE, ...result }
  } catch (error) {
    console.error('Storage read error:', error)
    return DEFAULT_STORAGE
  }
}
```

**마이그레이션 전**:
```json
{
  "userApiKey": "xK7j9mP1q2w3e4r5...",  // 단일 필드
  "dailyUsage": { ... },
  "settings": { ... }
}
```

**마이그레이션 후**:
```json
{
  "apiKeys": {
    "gemini": "xK7j9mP1q2w3e4r5...",  // 이동됨
    "chatgpt": "",
    "claude": ""
  },
  "dailyUsage": { ... },
  "settings": { ... }
}
```

---

## 6. 백업 및 복구

### 6.1 데이터 백업

**수동 백업**:
```typescript
export async function exportData(): Promise<string> {
  const data = await getStorageData()
  return JSON.stringify(data, null, 2)
}

// 사용 예시
const backup = await exportData()
// 파일로 저장하거나 클립보드에 복사
```

**자동 백업** (향후 개선):
- Chrome Sync를 통한 자동 동기화 (선택적)
- 로컬 파일 시스템 백업

### 6.2 데이터 복구

```typescript
export async function importData(jsonString: string): Promise<void> {
  try {
    const data = JSON.parse(jsonString)
    
    // 스키마 검증
    if (!data.apiKeys || !data.settings || !data.dailyUsage) {
      throw new Error('Invalid data format')
    }
    
    // 복구
    await chrome.storage.local.clear()
    await chrome.storage.local.set(data)
  } catch (error) {
    throw new Error('데이터 복구에 실패했습니다.')
  }
}
```

---

## 7. 성능 및 제한사항

### 7.1 Chrome Storage 제한

| 항목 | 제한 | 현재 사용량 | 여유 |
|------|------|-------------|------|
| **전체 용량** | 5 MB | < 1 KB | 99.98% |
| **키 개수** | 무제한 | 3개 | - |
| **쓰기 속도** | 제한 없음 | 평균 5ms | ✅ |
| **읽기 속도** | 제한 없음 | 평균 2ms | ✅ |

### 7.2 성능 최적화

**읽기 최적화**:
```typescript
// ✅ Good: 전체 데이터 한 번에 조회
const data = await getStorageData()
const provider = data.settings.selectedProvider
const apiKey = await getApiKey(provider)

// ❌ Bad: 여러 번 조회
const provider = await getSelectedProvider()
const apiKey = await getApiKey(provider)
```

**쓰기 최적화**:
```typescript
// ✅ Good: 배치 업데이트
await setStorageData({
  settings: { ...newSettings },
  dailyUsage: { ...newUsage }
})

// ❌ Bad: 여러 번 쓰기
await setStorageData({ settings: { ...newSettings } })
await setStorageData({ dailyUsage: { ...newUsage } })
```

### 7.3 에러 처리

**읽기 실패**:
```typescript
try {
  const data = await getStorageData()
} catch (error) {
  // 기본값 반환 (안전한 대체)
  return DEFAULT_STORAGE
}
```

**쓰기 실패**:
```typescript
try {
  await setStorageData({ ... })
} catch (error) {
  // 사용자에게 알림
  throw new Error('데이터 저장에 실패했습니다.')
}
```

---

## 8. 보안 고려사항

### 8.1 저장 위치

- ✅ Chrome Storage Local (브라우저 내부)
- ❌ 외부 서버 전송 금지
- ❌ Chrome Storage Sync 사용 금지 (보안)

### 8.2 암호화

- ✅ API 키는 항상 암호화 후 저장
- ✅ 평문 API 키는 메모리에서만 사용
- ✅ 사용 후 즉시 메모리 해제

### 8.3 접근 제어

```typescript
// ✅ 허용: storage.ts를 통한 접근만
const apiKey = await getApiKey('gemini')

// ❌ 금지: 직접 Chrome Storage 접근
const data = await chrome.storage.local.get('apiKeys')
```

---

## 9. 테스트 시나리오

```typescript
describe('Storage Tests', () => {
  beforeEach(async () => {
    await chrome.storage.local.clear()
  })
  
  test('기본값 조회', async () => {
    const data = await getStorageData()
    expect(data).toEqual(DEFAULT_STORAGE)
  })
  
  test('API 키 저장 및 조회', async () => {
    await saveApiKey('gemini', 'test-key')
    const key = await getApiKey('gemini')
    expect(key).toBe('test-key')
  })
  
  test('사용량 증가', async () => {
    const count1 = await updateDailyUsage()
    const count2 = await updateDailyUsage()
    expect(count2).toBe(count1 + 1)
  })
  
  test('데이터 마이그레이션', async () => {
    // v0.x 형식으로 저장
    await chrome.storage.local.set({
      userApiKey: 'old-key'
    })
    
    // v1.0으로 마이그레이션
    const data = await getStorageData()
    expect(data.apiKeys.gemini).toBe('old-key')
    expect(data.userApiKey).toBeUndefined()
  })
})
```

---

**문서 작성**: AI 코드 분석 시스템  
**최종 업데이트**: 2025-12-25

