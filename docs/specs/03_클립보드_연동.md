# 기능 상세 스펙 문서 - 03. 텍스트 조작 및 메시징

> **문서 버전**: 2.5.1 (2026.01.12 Update)
> **작성일**: 2026-01-01
> **업데이트**: 2026-01-12 - input/textarea 선택 텍스트 처리 개선 및 디버깅 로그 강화
> **담당 모듈**: `src/content/`, `src/background/commands.ts`

---

## 1. 개요 (v2.5.1)

단순 클립보드 연동을 넘어, 사용자가 현재 활성화된 웹페이지에서 직접 텍스트를 선택하고 AI 기능을 실행할 수 있는 통합 텍스트 조작 시스템을 제공합니다.

---

## 2. 핵심 기능

### 2.1 텍스트 선택 및 대체 (Instant Replacement)
- **기능**: 웹페이지에서 블록 지정된 텍스트를 즉시 AI 변환 결과로 교체합니다.
- **구현**:
    - `GET_SELECTED_TEXT`: 현재 선택된 텍스트를 추출하고 로딩 상태를 표시합니다.
    - `REPLACE_SELECTED_TEXT`: AI 변환 결과를 기존 선택 영역에 삽입합니다. `contenteditable` 엘리먼트 및 표준 입력 폼(`input`, `textarea`)을 지원합니다.

### 2.2 input/textarea 선택 텍스트 처리 (v2.5.1 개선)
- **문제점**: `window.getSelection()`은 일부 브라우저/상황에서 input/textarea의 선택 텍스트를 반환하지 않음
- **해결책**: `selectionStart/selectionEnd`를 사용하여 직접 선택 텍스트 추출
- **React 호환**: 텍스트 교체 후 `input`, `change` 이벤트를 발생시켜 프레임워크가 변경을 감지하도록 함

```typescript
// src/content/replacer.ts
if (activeElement instanceof HTMLTextAreaElement || activeElement instanceof HTMLInputElement) {
  const start = activeElement.selectionStart ?? 0;
  const end = activeElement.selectionEnd ?? 0;
  const selectedText = activeElement.value.substring(start, end);
  return selectedText;
}
```

### 2.3 백그라운드 명령어 (Global Commands)
- **단축키**: `manifest.json`에 정의된 전역 단축키를 통해 실행됩니다.
    - `instant-translation`: 선택 영역 즉시 번역 (기본 언어 설정 준수).
    - `instant-tone-conversion`: 선택 영역 즉시 톤 변환 (설정된 `instantToneStyle` 스타일 적용).
    - `tone-conversion`: 팝업 즉시 실행 및 클립보드 데이터 자동 로드.
- **메시지 버스**: Background Service Worker와 Content Script 간의 `chrome.tabs.sendMessage`를 통한 통신 체계.
- **하트비트**: 서비스 워커의 비정상 종료를 방지하기 위해 30초마다 `bca-heartbeat` 알람을 발생시켜 활성 상태 유지.

### 2.4 제한된 페이지 감지 (v2.5.1)
- **isRestrictedPage()**: 스크립트 실행이 제한된 페이지인지 확인
- **제한된 페이지 유형**:
    - `chrome://`, `chrome-extension://`, `edge://`, `about:`
    - `moz-extension://`, `file://`
    - Chrome 웹 스토어 (`chrome.google.com/webstore`)
    - Firefox 부가기능 (`addons.mozilla.org`)
- **사용자 알림**: 제한된 페이지에서 단축키 실행 시 시스템 알림으로 안내

### 2.5 시스템 알림 (v2.5.1)
- **showNotification()**: Content Script 없이도 사용자에게 피드백 제공
- **chrome.notifications API** 사용으로 브라우저 기본 알림 표시
- **활용 시나리오**:
    - 활성 탭을 찾을 수 없는 경우
    - 제한된 페이지에서 단축키 실행 시
    - Content Script 주입 실패 시

### 2.3 `tabs` 권한 사용 근거 (Permission Justification)
본 확장 프로그램은 원활한 사용자 경험과 웹페이지와의 직접적인 상호작용을 위해 `tabs` 권한을 다음과 같은 목적으로 사용합니다:
1. **현재 활성 탭 식별**: `chrome.tabs.query`를 사용하여 사용자가 단축키를 실행한 시점의 활성 탭 정보를 정확히 파악하고, 해당 페이지의 컨텍스트에서 작업을 수행합니다.
2. **컨텐츠 스크립트 통신**: `chrome.tabs.sendMessage`를 통해 배경(Background)과 웹페이지(Content Script) 간의 양방향 통신을 처리합니다. 이를 통해 선택된 텍스트를 가져오거나 변환된 결과를 페이지에 즉시 삽입합니다.
3. **사용자 편의 기능**: `chrome.tabs.create`를 활용하여 설정 페이지 내에서 단축키 설정 페이지(`chrome://extensions/shortcuts`) 등 외부 URL을 새 탭으로 여는 기능을 제공합니다.

---

## 3. 상세 프로세스

### 3.1 즉시 변환 흐름 (Background Logic)
1. **단축키 입력**: `chrome.commands.onCommand` 리스너 작동.
2. **상태 확인**: `isRestrictedPage()`로 현재 탭의 URL이 제한된 페이지인지 확인.
3. **스크립트 주입**: `ensureContentScriptReady()`를 통해 Content Script 상태 확인 및 필요 시 동적 주입.
4. **텍스트 추출**: Content Script로부터 선택된 텍스트 수신 (input/textarea는 `selectionStart/End` 사용).
5. **AI 실행**: `AIOrchestrator`를 통한 변환 수행.
6. **결과 적용**: 성공 시 Content Script에 대체 명령 전송, 실패 시 토스트 또는 시스템 알림 표시.

### 3.2 Content Script 동적 주입 (v2.5.1 개선)
```typescript
async function ensureContentScriptReady(tabId: number): Promise<boolean> {
  try {
    const response = await chrome.tabs.sendMessage(tabId, { action: 'PING' });
    return response?.message === 'pong';
  } catch (e) {
    // manifest.json에서 content_scripts 파일 경로 자동 로드
    const manifest = chrome.runtime.getManifest();
    const contentScriptFiles = manifest.content_scripts?.[0]?.js || [];
    
    await chrome.scripting.executeScript({
      target: { tabId },
      files: contentScriptFiles
    });
    // ...
  }
}
```

---

## 4. UI/UX 피드백

### 4.1 로딩 표시
- 텍스트 선택 시 `bca-selection-loading` 아이디를 가진 오버레이를 생성하여 처리 중임을 사용자에게 알립니다.
- **v2.5.1**: contentEditable이 아닌 일반 DOM에서만 로딩 스피너 삽입

### 4.2 토스트 알림 (Toast)
- 백그라운드에서 발생한 에러(API 키 오류, 네트워크 문제 등)를 사용자 페이지 상단에 세련된 토스트 UI로 표시합니다. (`src/content/toast.ts`)

### 4.3 시스템 알림 (v2.5.1)
- Content Script가 로드되지 않은 페이지에서도 `chrome.notifications` API를 통해 사용자에게 피드백 제공
- 제한된 페이지, 활성 탭 없음 등의 상황에서 활용

---

## 5. 보안 가이드라인

- **데이터 최소 노출**: 사용자가 선택한 텍스트는 변환 목적으로만 사용되며, 로컬 스토리지에 저장되지 않습니다.
- **안전한 DOM 접근**: `execCommand('insertText')` 또는 최신 Selection API를 사용하여 브라우저의 보안 정책을 준수하며 텍스트를 대체합니다.

---

## 6. 디버깅 로그 (v2.5.1)

### 6.1 Background Service Worker 로그
- `[BCA] Command received: {command}` - 단축키 수신
- `[BCA] Active tab: {id, url}` - 활성 탭 정보
- `[BCA] Registered commands:` - 등록된 단축키 목록
- `[BCA] Content script not ready, attempting injection...` - 동적 주입 시도

### 6.2 Content Script 로그
- `[BCA Content] Received action: {action}` - 메시지 수신
- `[BCA Content] Selected text extracted: {length, preview}` - 선택 텍스트 정보
- `[BCA Replacer] Input/Textarea selection: {start, end}` - input/textarea 선택 정보

---

**문서 업데이트**: 2026-01-12
